<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badminton Pro Manager | Cloud Edition</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --bg: #ecf0f1;
            --white: #ffffff;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg);
            color: var(--primary);
        }
        /* Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .login-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .login-card input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 { text-align: center; margin-top: 0; }
        
        textarea {
            width: 100%; height: 80px; padding: 12px;
            border: 2px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 14px; margin-bottom: 10px;
        }
        .controls-row { display: flex; gap: 10px; margin-bottom: 20px; }
        button {
            flex: 1; padding: 12px; background-color: var(--accent);
            color: white; border: none; border-radius: 6px;
            cursor: pointer; font-size: 16px; font-weight: bold;
        }
        button:hover { opacity: 0.9; }
        button.secondary { background-color: #95a5a6; }

        #duo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px; margin-bottom: 15px;
        }
        .duo-card {
            background: #f9f9f9; border: 2px solid #eee;
            padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;
        }
        .duo-card.selected { border-color: var(--accent); background: #e8f5e9; }

        .scoreboard {
            display: flex; justify-content: space-around;
            align-items: center; background: #f8f9fa;
            padding: 20px; border-radius: 10px; border: 2px solid #eee;
        }
        .score-display { font-size: 3.5rem; font-weight: 800; margin: 10px 0; }
        .team-input {
            font-size: 1.1rem; font-weight: bold; text-align: center;
            border: none; border-bottom: 2px solid #ddd; width: 100%;
        }
        .btn-score { font-size: 1.5rem; width: 45px; height: 45px; border-radius: 50%; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: var(--primary); color: white; }
        .win-tag { color: var(--accent); font-weight: bold; }
        .waitlist-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-card">
            <h2 style="color: var(--primary)">üè∏ Pro Manager Login</h2>
            <p>Enter admin credentials to start session</p>
            <input type="email" id="loginEmail" placeholder="Admin Email">
            <input type="password" id="loginPass" placeholder="Password">
            <button id="btnLogin">Login to Dashboard</button>
            <p id="loginError" style="color: var(--danger); font-size: 0.8rem; margin-top:10px;"></p>
        </div>
    </div>

    <h1>üè∏ Badminton Pro Manager</h1>

    <div class="card">
        <h2>1. Generate Pairs</h2>
        <textarea id="names" placeholder="John, Sarah, Mike, Anna..."></textarea>
        <div class="controls-row">
            <button id="generate">Shuffle & Create Duos</button>
            <button id="clear" class="secondary">Reset Session</button>
        </div>
        <div id="duo-grid"></div>
        <div id="extra-player"></div>
    </div>

    <div class="card">
        <h2>2. Live Match Tracker</h2>
        <div class="scoreboard">
            <div class="team">
                <input type="text" id="teamAName" class="team-input" value="Team A">
                <div class="score-display" id="scoreA">0</div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-score" style="background: var(--danger);" onclick="changeScore('A', -1)">-</button>
                    <button class="btn-score" style="background: var(--accent);" onclick="changeScore('A', 1)">+</button>
                </div>
            </div>
            <div style="font-weight: bold; color: #999;">VS</div>
            <div class="team">
                <input type="text" id="teamBName" class="team-input" value="Team B">
                <div class="score-display" id="scoreB">0</div>
                <div style="display:flex; gap:5px; justify-content:center;">
                    <button class="btn-score" style="background: var(--danger);" onclick="changeScore('B', -1)">-</button>
                    <button class="btn-score" style="background: var(--accent);" onclick="changeScore('B', 1)">+</button>
                </div>
            </div>
        </div>
        <button id="manualSave" class="secondary" style="margin-top:15px; width:100%;">Save Match Manually</button>
    </div>

    <div class="card">
        <h2>3. Global Session History</h2>
        <div style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Matchup</th>
                        <th>Score</th>
                        <th>Winner</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAR7u_Zpb14QmT1wVxUCTzxdbfliobthFQ",
            authDomain: "badminton-pro-ss.firebaseapp.com",
            projectId: "badminton-pro-ss",
            storageBucket: "badminton-pro-ss.firebasestorage.app",
            messagingSenderId: "293937701170",
            appId: "1:293937701170:web:40e1d3be4392a35c6c372b",
            measurementId: "G-Y7N6Q70QP4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Authentication Logic ---
        document.getElementById('btnLogin').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                document.getElementById('loginError').innerText = "Access Denied: Check Email/Password";
            }
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('login-overlay').style.display = 'none';
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
            }
        });

        // --- Database Logic: Save Match ---
        async function cloudSaveMatch(nA, sA, nB, sB, winner) {
            try {
                await addDoc(collection(db, "matches"), {
                    teamA: nA,
                    teamB: nB,
                    scoreA: sA,
                    scoreB: sB,
                    winner: winner,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        // --- Database Logic: Live History Update ---
        const q = query(collection(db, "matches"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            snapshot.forEach((doc) => {
                const m = doc.data();
                const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : "...";
                const row = `<tr>
                    <td>${time}</td>
                    <td>${m.teamA} vs ${m.teamB}</td>
                    <td>${m.scoreA} - ${m.scoreB}</td>
                    <td class="win-tag">${m.winner}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        });

        // --- Game Logic ---
        let scoreA = 0;
        let scoreB = 0;

        window.changeScore = (team, val) => {
            if (team === 'A') {
                scoreA = Math.max(0, scoreA + val);
                document.getElementById('scoreA').innerText = scoreA;
            } else {
                scoreB = Math.max(0, scoreB + val);
                document.getElementById('scoreB').innerText = scoreB;
            }
            checkWinner();
        };

        function checkWinner() {
            const nA = document.getElementById('teamAName').value;
            const nB = document.getElementById('teamBName').value;
            if ((scoreA >= 21 || scoreB >= 21) && Math.abs(scoreA - scoreB) >= 2) {
                const winner = scoreA > scoreB ? nA : nB;
                cloudSaveMatch(nA, scoreA, nB, scoreB, winner);
                alert(`üéâ ${winner} Wins! Match saved to cloud.`);
                resetBoard();
            }
        }

        document.getElementById('manualSave').addEventListener('click', () => {
            const nA = document.getElementById('teamAName').value;
            const nB = document.getElementById('teamBName').value;
            const winner = scoreA > scoreB ? nA : nB;
            cloudSaveMatch(nA, scoreA, nB, scoreB, winner);
            resetBoard();
        });

        function resetBoard() {
            scoreA = 0; scoreB = 0;
            document.getElementById('scoreA').innerText = 0;
            document.getElementById('scoreB').innerText = 0;
            document.getElementById('teamAName').value = "Team A";
            document.getElementById('teamBName').value = "Team B";
            document.querySelectorAll('.duo-card').forEach(c => c.classList.remove('selected'));
        }

        // --- Pairing Logic ---
        document.getElementById('generate').addEventListener('click', () => {
            const names = document.getElementById('names').value.split(/[\n,]+/).map(n => n.trim()).filter(n => n !== "");
            if (names.length < 2) return alert("Add more names!");

            for (let i = names.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [names[i], names[j]] = [names[j], names[i]];
            }

            const grid = document.getElementById('duo-grid');
            const extra = document.getElementById('extra-player');
            grid.innerHTML = ''; extra.innerHTML = '';
            
            let waitlist = names.length % 2 !== 0 ? names.pop() : null;

            for (let i = 0; i < names.length; i += 2) {
                const pair = `${names[i]} & ${names[i+1]}`;
                const card = document.createElement('div');
                card.className = 'duo-card';
                card.innerHTML = `<strong>Pair ${Math.floor(i/2)+1}</strong><br>${pair}`;
                card.onclick = () => {
                    const tA = document.getElementById('teamAName');
                    const tB = document.getElementById('teamBName');
                    if(tA.value === "Team A") { tA.value = pair; card.classList.add('selected'); }
                    else if(tB.value === "Team B") { tB.value = pair; card.classList.add('selected'); }
                };
                grid.appendChild(card);
            }
            if (waitlist) extra.innerHTML = `<div class="waitlist-alert"><strong>Resting:</strong> ${waitlist}</div>`;
        });

        document.getElementById('clear').addEventListener('click', () => { if(confirm("Reset everything?")) location.reload(); });
    </script>
</body>
</html>
